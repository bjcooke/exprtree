CC=@CC@
CFLAGS=-Wall -ansi -pedantic -Wno-variadic-macros -iquote @srcdir@/include @CFLAGS@
LD=@CC@
LDFLAGS=-Wall -ansi -pedantic @LDFLAGS@
LIBS=@LIBS@
AWK=@AWK@
PRINTF=@PRINTF@
RM=@RM@

hsrc=$(wildcard @srcdir@/script/*-header.awk)
hdr=$(hsrc:@srcdir@/script/%-header.awk=@srcdir@/include/%.h)
ascript=$(wildcard @srcdir@/script/*-source.awk)
dycsrc=$(ascript:@srcdir@/script/%-source.awk=@srcdir@/src/%.c)
csrc=$(sort $(wildcard @srcdir@/src/*.c) $(dycsrc))
obj=$(csrc:@srcdir@/src/%.c=./%.o)
tsrc=$(wildcard @srcdir@/test/*.c)
tobj=$(tsrc:@srcdir@/test/%.c=./test/%.o)
texe=$(tobj:.o=)


exprtree:	./main.o $(obj)
	$(LD) $(LDFLAGS) -o $@ $^ $(LIBS)

help:
	@ $(PRINTF) "Options:\n\n"
	@ $(PRINTF) "\ttest\n"
	@ $(PRINTF) "\theaders\n"
	@ $(PRINTF) "\tsource\n"
	@ $(PRINTF) "\tclean\n"
	@ $(PRINTF) "\n"


test:		$(texe)

headers:	$(hdr)

source:		$(dycsrc)


@srcdir@/include/%.h:	@srcdir@/script/%-header.awk include
	@$(AWK) -f $< @srcdir@/src/template/tokens.tbl > $@
	@$(PRINTF) "AWK\t$(notdir $^)\n\t|\n\t*=> $(notdir $@)\n\n"

@srcdir@/src/%.c:	@srcdir@/script/%-source.awk
	@$(RM) -f $@
	@$(AWK) -f $< @srcdir@/src/template/tokens.tbl > $@
	@$(PRINTF) "AWK\t$(notdir $^)\n\t|\n\t*=> $(notdir $@)\n\n"

./%.o:	@srcdir@/src/%.c source headers
	@$(CC) $(CFLAGS) -c $< -o $@
	@$(PRINTF) "CC\t$(notdir $<)\n\t|\n\t*=> $(notdir $@)\n\n"

./test:
	@test -d $@ || $(MKDIR) $@
./test/%:		@srcdir@/test/%.c source headers $(obj)
	@$(CC) $(CFLAGS) -c $< -o $@.o
	@$(PRINTF) "CC\t$(notdir $<)\n\t|\n\t*=> $(notdir $@.o)\n\n"
	@$(LD) $(LDFLAGS) -o $@ $@.o $(obj) $(TESTLIBS)
	@$(PRINTF) "LD\t$(notdir $@)\n\n"


clean:
	@$(RM) -f $(wildcard exprtree)
	@$(RM) -f $(wildcard $(hdr))
	@$(RM) -f $(wildcard $(dycsrc))
	@$(RM) -f $(wildcard $(obj))
	@$(RM) -f $(wildcard $(tobj))
	@$(RM) -f $(wildcard $(texe))
	@$(PRINTF) "RM\t%s\n" \
		$(notdir $(wildcard $(hdr))) \
		$(notdir $(wildcard $(dycsrc))) \
		$(notdir $(wildcard $(obj))) \
		$(notdir $(wildcard $(tobj))) \
		$(notdir $(wildcard $(texe)))

distclean:	clean
	$(RM) -rf Makefile configure config.status config.log autom4te.cache/ \
script/*.awk script/*.sed
